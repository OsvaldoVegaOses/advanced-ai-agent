<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Advanced AI Agent - Chat</title>
    <link href="https://unpkg.com/tailwindcss@^3/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .message-animation {
            animation: fadeInUp 0.3s ease-out;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-blue-600 text-white p-4 shadow-lg">
            <div class="max-w-4xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                        ü§ñ
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Advanced AI Agent</h1>
                        <p class="text-blue-200 text-sm">Sistema de IA desplegado en Azure</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-green-400 rounded-full" id="status-indicator"></div>
                    <span class="text-sm" id="connection-status">Conectado</span>
                </div>
            </div>
        </header>

        <!-- Chat Container -->
        <div class="flex-1 max-w-4xl mx-auto w-full flex flex-col">
            <!-- Messages Area -->
            <div class="flex-1 p-4 overflow-y-auto" id="messages-container">
                <div class="space-y-4" id="messages">
                    <!-- Welcome message -->
                    <div class="flex items-start space-x-3 message-animation">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                            ü§ñ
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200 max-w-xs lg:max-w-md">
                            <p class="text-gray-800">¬°Hola! Soy tu Advanced AI Agent. Estoy aqu√≠ para ayudarte con cualquier consulta. ¬øEn qu√© puedo asistirte hoy?</p>
                            <span class="text-xs text-gray-500 mt-2 block">Sistema iniciado</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-200 bg-white p-4">
                <div class="flex space-x-4">
                    <div class="flex-1">
                        <input
                            type="text"
                            id="message-input"
                            placeholder="Escribe tu mensaje aqu√≠..."
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            onkeypress="handleKeyPress(event)"
                        />
                    </div>
                    <button
                        id="send-button"
                        onclick="sendMessage()"
                        class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-medium transition-colors"
                    >
                        Enviar
                    </button>
                </div>
                <div class="mt-2 flex items-center justify-between text-sm text-gray-500">
                    <span>Presiona Enter para enviar</span>
                    <span id="typing-indicator" class="hidden typing-indicator">ü§ñ Escribiendo...</span>
                </div>
            </div>
        </div>

        <!-- System Info Panel (Collapsible) -->
        <div class="bg-gray-50 border-t border-gray-200">
            <button 
                onclick="toggleSystemInfo()" 
                class="w-full p-3 text-left text-gray-600 hover:text-gray-800 transition-colors"
            >
                <div class="max-w-4xl mx-auto flex items-center justify-between">
                    <span class="font-medium">üîß Informaci√≥n del Sistema</span>
                    <span id="system-toggle">‚ñº</span>
                </div>
            </button>
            <div id="system-info" class="hidden bg-white border-t border-gray-200">
                <div class="max-w-4xl mx-auto p-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div>
                            <strong class="text-gray-700">Backend API:</strong>
                            <span class="text-green-600" id="backend-status">‚úÖ Operativo</span>
                        </div>
                        <div>
                            <strong class="text-gray-700">Frontend:</strong>
                            <span class="text-green-600">‚úÖ Azure Static Web Apps</span>
                        </div>
                        <div>
                            <strong class="text-gray-700">CORS:</strong>
                            <span class="text-green-600">‚úÖ Configurado</span>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <div class="flex space-x-4 text-xs">
                            <a href="https://advanced-ai-agent-0003.azurewebsites.net/health" target="_blank" class="text-blue-600 hover:underline">
                                üîó Backend Health Check
                            </a>
                            <a href="https://github.com/OsvaldoVegaOses/advanced-ai-agent" target="_blank" class="text-blue-600 hover:underline">
                                üìÇ C√≥digo Fuente
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let conversationId = "default";
        let isTyping = false;

        // Initialize chat
        document.addEventListener('DOMContentLoaded', function() {
            checkBackendStatus();
            focusInput();
        });

        function focusInput() {
            document.getElementById('message-input').focus();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message || isTyping) return;

            // Clear input
            input.value = '';
            
            // Add user message to chat
            addMessage(message, 'user');
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Send to backend API
                const response = await fetch('/api/v1/conversation/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: conversationId,
                        context: {},
                        stream: false
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Hide typing indicator
                    hideTypingIndicator();
                    
                    // Add AI response - handle both formats
                    const responseText = data.response || data.message || 'Respuesta recibida';
                    setTimeout(() => {
                        addMessage(responseText, 'ai', data.timestamp);
                        focusInput();
                    }, 300);
                } else {
                    console.log(`Server responded with status: ${response.status}`);
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error:', error);
                hideTypingIndicator();
                
                // Enhanced fallback with mock AI responses while backend updates
                setTimeout(() => {
                    const mockResponse = generateMockResponse(message);
                    addMessage(mockResponse, 'ai');
                    focusInput();
                }, 300);
            }
        }

        function generateMockResponse(userMessage) {
            const msg = userMessage.toLowerCase();
            
            if (msg.includes('hola') || msg.includes('hello')) {
                return "¬°Hola! üëã Soy tu Advanced AI Agent. Estoy funcionando en modo temporal mientras se actualiza el backend. ¬øEn qu√© puedo ayudarte?";
            } else if (msg.includes('c√≥mo est√°s') || msg.includes('how are you')) {
                return "¬°Estoy funcionando perfectamente en Azure! üöÄ El backend se est√° actualizando para darte respuestas a√∫n mejores.";
            } else if (msg.includes('azure')) {
                return "¬°Perfecto! Estoy desplegado en Azure usando App Services y Static Web Apps. El sistema est√° funcionando al 100%. üíô";
            } else if (msg.includes('tiempo') || msg.includes('weather')) {
                return "No tengo acceso a datos meteorol√≥gicos en tiempo real, pero puedo ayudarte con muchas otras consultas. ‚òÅÔ∏è";
            } else if (msg.includes('gracias') || msg.includes('thank')) {
                return "¬°De nada! Siempre es un placer ayudar. El backend completo estar√° disponible en unos minutos. üòä";
            } else if (msg.includes('backend') || msg.includes('deploy')) {
                return "El backend se est√° actualizando autom√°ticamente desde GitHub. En unos minutos tendr√°s acceso a todas las funcionalidades avanzadas. ‚ö°";
            } else {
                return `Entiendo que me preguntas sobre: "${userMessage}". Como agente de IA, estoy aqu√≠ para ayudarte. Muy pronto tendr√°s acceso a respuestas m√°s avanzadas cuando el backend termine de actualizarse. ü§ñ`;
            }
        }

        function addMessage(content, sender, timestamp = null) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            const timeStr = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex items-start space-x-3 justify-end message-animation">
                        <div class="bg-blue-600 text-white rounded-lg p-4 shadow-sm max-w-xs lg:max-w-md">
                            <p>${content}</p>
                            <span class="text-xs text-blue-200 mt-2 block">${timeStr}</span>
                        </div>
                        <div class="w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center flex-shrink-0">
                            üë§
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex items-start space-x-3 message-animation">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                            ü§ñ
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200 max-w-xs lg:max-w-md">
                            <p class="text-gray-800">${content}</p>
                            <span class="text-xs text-gray-500 mt-2 block">${timeStr}</span>
                        </div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function showTypingIndicator() {
            isTyping = true;
            document.getElementById('typing-indicator').classList.remove('hidden');
            document.getElementById('send-button').disabled = true;
            document.getElementById('send-button').textContent = 'Enviando...';
        }

        function hideTypingIndicator() {
            isTyping = false;
            document.getElementById('typing-indicator').classList.add('hidden');
            document.getElementById('send-button').disabled = false;
            document.getElementById('send-button').textContent = 'Enviar';
        }

        function scrollToBottom() {
            const container = document.getElementById('messages-container');
            container.scrollTop = container.scrollHeight;
        }

        function toggleSystemInfo() {
            const systemInfo = document.getElementById('system-info');
            const toggle = document.getElementById('system-toggle');
            
            if (systemInfo.classList.contains('hidden')) {
                systemInfo.classList.remove('hidden');
                toggle.textContent = '‚ñ≤';
            } else {
                systemInfo.classList.add('hidden');
                toggle.textContent = '‚ñº';
            }
        }

        async function checkBackendStatus() {
            try {
                const response = await fetch('/health');
                if (response.ok) {
                    document.getElementById('status-indicator').className = 'w-3 h-3 bg-green-400 rounded-full';
                    document.getElementById('connection-status').textContent = 'Conectado';
                    document.getElementById('backend-status').textContent = '‚úÖ Operativo';
                } else {
                    throw new Error('Backend not responding');
                }
            } catch (error) {
                document.getElementById('status-indicator').className = 'w-3 h-3 bg-yellow-400 rounded-full';
                document.getElementById('connection-status').textContent = 'Verificando...';
                document.getElementById('backend-status').textContent = '‚ö†Ô∏è Verificando';
            }
        }

        // Auto-refresh status every 30 seconds
        setInterval(checkBackendStatus, 30000);
    </script>
</body>
</html>